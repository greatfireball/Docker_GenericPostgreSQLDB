* A generic PostgreSQL database container for docker
** Introduction
   This project was originally initiated during the development of our
   [[https://github.com/TBroTeam/TBro][Transcript Browser (TBro)]]. We want to create a PostgreSQL database
   container, which is able to provide a basic security level and
   which creates a new empty database during database creation
   process.
** Version
   0.1
** Description
** Source code
   We start from the default postgres container
   #+BEGIN_SRC sh :tangle ../docker/Dockerfile
     FROM postgres:9.4
   #+END_SRC

   #+BEGIN_SRC sh :tangle ../docker/000_fix-acl.sh :shebang "#!/bin/bash"
     echo "******MODIFYING PG_HBA.CONF******"
     cat > /var/lib/postgresql/data/pg_hba.conf <<EOS
     # Generated by fix-acl.sh
     # TYPE  DATABASE        USER            ADDRESS                 METHOD
     # "local" is for Unix domain socket connections only
     local   all             all                                     trust
     # IPv4 local connections:
     host    all             all             127.0.0.1/32            trust
     # IPv6 local connections:
     host    all             all             ::1/128                 trust

     # Allow anyone to connect remotely so long as they have a valid username and
     # password.
     host all all 0.0.0.0/0 md5
     EOS
     echo ""
     echo "******MODIFYING PG_HBA.CONF FINISHED******"
   #+END_SRC

   #+BEGIN_SRC sh :tangle ../docker/010_create_user_db.sh :shebang "#!/bin/bash"
     # Check if the environment variables DB_* exist otherwise take default values
     DB_NAME=${DB_NAME:-mydatabase}
     DB_PW=${DB_PW:-mypassword}
     DB_USER=${DB_USER:-myuser}
     echo "******CREATING DOCKER DATABASE******"
     gosu postgres postgres --single <<- EOSQL
        CREATE DATABASE $DB_NAME;
        CREATE ROLE $DB_USER ENCRYPTED PASSWORD '$DB_PW' NOSUPERUSER CREATEDB NOCREATEROLE INHERIT LOGIN;
        ALTER DATABASE $DB_NAME OWNER TO $DB_USER;
        GRANT ALL PRIVILEGES ON DATABASE $DB_NAME to $DB_USER;
     EOSQL
     echo ""
     echo "******DOCKER DATABASE CREATED******"
   #+END_SRC

   Finally I have to add a user to the database
   #+BEGIN_SRC sh :tangle ../docker/Dockerfile
     ADD 000_fix-acl.sh /docker-entrypoint-initdb.d/
     ADD 010_create_user_db.sh /docker-entrypoint-initdb.d/
   #+END_SRC

*** Container Building
   Building the database container is now provided by DockerHub. The
   generic database container can be retrieved from [[https://registry.hub.docker.com/u/greatfireball/generic_postgresql_db/][DockerHub]] using
   the command:
   #+BEGIN_SRC sh
     docker pull greatfireball/generic_postgresql_db
   #+END_SRC

** History
   <2015-03-11 Mi> First version of the standalone database container
